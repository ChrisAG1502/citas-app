<!doctype html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/resources/css/style.css}">
    <title>Partner Dashboard | Citas</title>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg green-section bg-light">
    <div class="container">
        <a href="#" class="navbar-brand">Logo</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="fa-solid fa-circle-user text-black fs-1"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
            <!-- Versión móvil - opciones visibles -->
            <ul class="navbar-nav me-auto d-lg-none p-0">
                <li class="nav-item py-0"> <!-- py-0 elimina padding vertical -->
                    <a class="nav-link fs-5" href="/user-account">Cuenta</a>
                </li>
                <li class="nav-item py-0"> <!-- py-0 elimina padding vertical -->
                    <a class="nav-link fs-5" href="/logout">Cerrar Sesión</a>
                </li>
            </ul>

            <!-- Versión escritorio - icono de cuenta con dropdown -->
            <ul class="navbar-nav ms-auto d-none d-lg-flex">
                <li class="nav-item dropdown">
                    <a class="nav-link text-white fs-5" href="#" role="button" data-bs-toggle="dropdown" id="dr">
                        <i class="fa-solid fa-circle-user text-black fs-2"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/user-account">Cuenta</a></li>
                        <li><a class="dropdown-item" href="/logout">Cerrar Sesión</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
<section class="welcome-message bg-light">
    <div class="justify-content-center text-center mb-4">
        <h4 class="text-capitalize fs-3 fs-md-2">
            <span th:text="${gender}"></span>
            <span th:text="${customerName}"></span></h4>
        <p class="mb-0 fs-5 fs-md-4">Panel de Control de Partner</p>
    </div>
</section>
<section class="new-announce bg-light">
    <div class="d-flex container justify-content-center">
        <a th:href="@{/dashboard/profesional/anuncios/nuevo}" class="btn custom-btn-check btn-lg py-3 mt-2 mb-2">Publicar
            Anuncio</a>
        <button type="button" class="btn btn-secondary btn-lg py-3 m-2">Administrar Citas</button>
    </div>
</section>

<!--Stats Container-->
<section class="main-container h-100 mt-3 mb-3 bg-light">
    <div class="container">
        <div class="row g-4">
            <!-- Sección de estadísticas numéricas -->
            <div class="col-lg-6">
                <div class="row g-4 ">
                    <!-- Anuncios publicados -->
                    <div class="col-md-6">
                        <div class="stat-card p-4 bg-white text-center">
                            <div class="stat-icon text-primary">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="text-capitalize fs-2" th:text="${totalPublicaciones}"></div>
                            <div class="stat-label">Anuncios publicados</div>
                        </div>
                    </div>

                    <!-- Vistas totales -->
                    <div class="col-md-6">
                        <div class="stat-card p-4 bg-white text-center">
                            <div class="stat-icon text-success">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="text-capitalize fs-2" th:text="${totalVistas}"></div>
                            <div class="stat-label">Vistas totales</div>
                        </div>
                    </div>

                    <!-- Anuncio con más vistas -->
                    <div class="col-md-6 text-center">
                        <div class="stat-card p-4 bg-white">
                            <div class="stat-icon text-warning">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="text-capitalize fs-2"
                                 th:text="${publicacionMasVista} ?: 'No hay anuncios'"></div>
                            <div class="stat-label">Anuncio con más vistas</div>
                        </div>
                    </div>

                    <!-- Vistas del anuncio destacado -->
                    <div class="col-md-6">
                        <div class="stat-card p-4 bg-white text-center">
                            <div class="stat-icon text-info">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="text-capitalize fs-2" th:text="${vistasPublicacionDestacada}"></div>
                            <div class="stat-label">Vistas del anuncio destacado</div>
                        </div>
                    </div>

                    <!-- Citas agendadas -->
                    <div class="col-12">
                        <div class="stat-card p-4 bg-white text-center">
                            <div class="stat-icon text-danger">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="text-capitalize fs-2" th:text="${totalCitas}"></div>
                            <div class="stat-label">Citas agendadas</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección del gráfico de pastel -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="text-center mb-4">Distribución de Vistas</h5>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="published-announces py-2">
    <div class="mb-4 pt-4 container">
        <p class="fs-4 text-capitalize">Anuncios Publicados</p>
        <div class="divider"></div>

        <div class="row m-4" th:if="${not #lists.isEmpty(publicaciones)}">
            <div class="col-md-4 mb-4" th:each="publicacion : ${publicaciones}">
                <div class="card h-100">
                    <div class="position-relative">
                        <img th:src="@{'/uploads/' + ${publicacion.imagenPrincipal}}"
                             class="card-img-top"
                             alt="Imagen del anuncio"
                             style="height: 180px; object-fit: cover;">
                        <!-- Botones de acción flotantes -->
                        <div class="position-absolute top-0 end-0 p-2">
                            <div class="btn-group" role="group">
                                <a th:href="@{'/dashboard/profesional/anuncios/editar/' + ${publicacion.id}}"
                                   class="btn btn-sm btn-outline-primary rounded-circle"
                                   title="Editar anuncio">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="#"
                                   th:onclick="'confirmarEliminacion(' + ${publicacion.id} + ')'"
                                   class="btn btn-sm btn-outline-primary rounded-circle"
                                   title="Eliminar anuncio">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" th:text="${publicacion.titulo}"></h5>
                        <p class="card-text"
                           th:text="${publicacion.descripcion.length() > 100 ?
                                     publicacion.descripcion.substring(0, 100) + '...' :
                                     publicacion.descripcion}"></p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="service-category" th:text="${publicacion.categoria.nombre}"></span>
                            <span class="text-muted"
                                  th:text="'$' + ${#numbers.formatDecimal(publicacion.precio, 1, 2, 'COMMA')}"></span>
                        </div>
                    </div>
                    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                        <small class="text-muted"
                               th:text="${#temporals.format(publicacion.fechaCreacion, 'dd/MM/yyyy')}"></small>
                        <span>
                            <i class="fas fa-eye"></i>
                            <span th:text="${publicacion.vistas}"></span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info" th:if="${#lists.isEmpty(publicaciones)}">
            No tienes anuncios publicados aún.
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Anuncio destacado', 'Otros anuncios', 'Citas agendadas'],
            datasets: [{
                data: [
                    [[${vistasPublicacionDestacada}]],
                    [[${totalVistas -vistasPublicacionDestacada}]],
                    [[${totalCitas}]]
                ],
                backgroundColor: [
                    '#FFC107',
                    '#28A745',
                    '#DC3545'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    function confirmarEliminacion(id) {
        if (confirm("¿Estás seguro de eliminar este anuncio?")) {
            fetch(`/dashboard/profesional/anuncios/eliminar/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content // Forma correcta de obtener CSRF
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Recargar la página o actualizar la lista de anuncios
                        window.location.reload();
                        // O redirigir al dashboard:
                        // window.location.href = '/dashboard/profesional';
                    } else {
                        return response.text().then(text => { throw new Error(text) });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Error al eliminar el anuncio: " + error.message);
                });
        }
    }
</script>
</body>
</html>